name: Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.15.0"
  GO_VERSION: "1.23"

jobs:
  preview-deploy:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Configure pnpm store
        run: pnpm config set store-dir $HOME/.pnpm-store

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: $HOME/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Restore Go cache
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.cache/go-build
            $HOME/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Restore Nx cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('**/pnpm-lock.yaml', 'nx.json', 'tsconfig.base.json', 'jest.config.ts', 'jest.preset.js') }}
          restore-keys: |
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build affected applications
        run: |
          # Get affected apps
          AFFECTED_APPS=$(pnpm nx show projects --affected --base=origin/main --head=${{ github.head_ref || github.ref_name }} --type=app)
          echo "Affected apps: $AFFECTED_APPS"
          
          # Build each affected app
          for app in $AFFECTED_APPS; do
            echo "Building $app..."
            pnpm nx build $app --configuration=production
          done

      - name: Prepare preview directory
        run: |
          mkdir -p preview/pr-${{ github.event.number }}
          cd dist
          
          # Copy built applications to preview directory
          for dir in */; do
            if [ -d "$dir" ]; then
              echo "Copying $dir to preview..."
              cp -r "$dir" "../preview/pr-${{ github.event.number }}/"
            fi
          done

      - name: Create index.html for preview
        run: |
          cat > preview/pr-${{ github.event.number }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Preview - PR #${{ github.event.number }}</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .app { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                  .app h3 { margin-top: 0; color: #333; }
                  .app a { color: #0066cc; text-decoration: none; }
                  .app a:hover { text-decoration: underline; }
                  .status { padding: 10px; background: #e8f5e8; border-radius: 4px; margin-bottom: 20px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸš€ Preview Environment - PR #${{ github.event.number }}</h1>
                  <div class="status">
                      <strong>âœ… Build completed successfully!</strong><br>
                      This preview contains the affected applications from your pull request.
                  </div>
                  
                  <h2>Available Applications:</h2>
                  <div class="app">
                      <h3>BFF NestJS</h3>
                      <p>Backend for Frontend service built with NestJS</p>
                      <a href="./bff-nest/index.html" target="_blank">Open BFF NestJS â†’</a>
                  </div>
                  
                  <div class="app">
                      <h3>Express Notifier</h3>
                      <p>Notification service built with Express</p>
                      <a href="./express-notifier/index.html" target="_blank">Open Express Notifier â†’</a>
                  </div>
                  
                  <div class="app">
                      <h3>User Go Service</h3>
                      <p>User management service built with Go</p>
                      <a href="./user-go-service/" target="_blank">Open User Go Service â†’</a>
                  </div>
                  
                  <hr>
                  <p><small>This preview will be automatically removed when the PR is closed.</small></p>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview/pr-${{ github.event.number }}
          destination_dir: pr-${{ github.event.number }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.number }}/`;
            
            const comment = `## ðŸš€ Preview Environment Deployed
            
            Your changes have been deployed to a preview environment:
            
            **ðŸ”— [View Preview](${previewUrl})**
            
            ### What's included:
            - âœ… All affected applications built successfully
            - ðŸ”„ Automatically updated on new commits
            - ðŸ—‘ï¸ Will be removed when PR is closed
            
            ### Available Services:
            - **BFF NestJS**: [${previewUrl}bff-nest/](${previewUrl}bff-nest/)
            - **Express Notifier**: [${previewUrl}express-notifier/](${previewUrl}express-notifier/)
            - **User Go Service**: [${previewUrl}user-go-service/](${previewUrl}user-go-service/)
            
            ---
            *This preview is automatically generated by the CI/CD pipeline.*`;
            
            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Environment Deployed')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  preview-cleanup:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Remove preview directory
        run: |
          # Remove the preview directory from gh-pages
          git checkout gh-pages || git checkout -b gh-pages
          rm -rf pr-${{ github.event.number }} || true
          git add -A
          git commit -m "Remove preview for PR #${{ github.event.number }}" || true
          git push origin gh-pages || true

      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ—‘ï¸ Preview Environment Removed
            
            The preview environment for this PR has been automatically removed.
            
            ---
            *This cleanup is automatically performed when the PR is closed.*`;
            
            // Find and update the existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Environment Deployed')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            }
