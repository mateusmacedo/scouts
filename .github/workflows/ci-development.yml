name: CI Development

on:
  push:
    branches: [ feat/*, feature/*, bugfix/*, hotfix/* ]
  pull_request:
    branches: [ develop ]

jobs:
  development-check:
    name: Development Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          filter: tree:0

      - name: Detect Changes
        id: changes
        run: |
          echo "ğŸ” Detectando tipos de mudanÃ§as..."
          if git diff --name-only HEAD~1 | grep -E '\.(ts|js|tsx|jsx)$' > /dev/null; then
            echo "has_js_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… MudanÃ§as em TypeScript/JavaScript detectadas"
          else
            echo "has_js_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma mudanÃ§a em TypeScript/JavaScript"
          fi
          
          if git diff --name-only HEAD~1 | grep -E '\.(go)$' > /dev/null; then
            echo "has_go_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… MudanÃ§as em Go detectadas"
          else
            echo "has_go_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma mudanÃ§a em Go"
          fi

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        id: node-pnpm-setup
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GL_TOKEN }}

      - name: Setup Go
        uses: ./.github/actions/setup-go
        with:
          has-go-changes: ${{ steps.changes.outputs.has_go_changes }}
        id: go-setup

      - name: Restore Nx cache
        uses: ./.github/actions/restore-nx-cache
        id: nx-cache

      - name: Set base reference for affected calculations
        id: base-ref
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_ref=origin/${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "base_ref=HEAD~1" >> $GITHUB_OUTPUT
          fi

      - name: Quick Quality Check
        continue-on-error: true
        if: steps.changes.outputs.has_js_changes == 'true'
        run: |
          echo "ğŸ” Executando verificaÃ§Ãµes rÃ¡pidas (nÃ£o bloqueantes)..."

          timeout 180 pnpm nx affected --target=lint --base=${{ steps.base-ref.outputs.base_ref }} --parallel=3 &
          timeout 180 pnpm nx affected --target=format --base=${{ steps.base-ref.outputs.base_ref }} --parallel=3 &
          timeout 180 pnpm nx affected --target=typecheck --base=${{ steps.base-ref.outputs.base_ref }} --parallel=3 &

          wait

          echo "âœ… VerificaÃ§Ãµes rÃ¡pidas concluÃ­das"

      - name: Run Tests
        run: |
          echo "ğŸ§ª Executando testes (obrigatÃ³rio)..."
          
          # Verificar projetos com target test disponÃ­vel
          echo "ğŸ” Procurando projetos com testes..."
          PROJECTS_WITH_TESTS=$(pnpm nx show projects --with-target=test)
          
          if [ -z "$PROJECTS_WITH_TESTS" ]; then
            echo "â„¹ï¸ Nenhum projeto com target 'test' encontrado."
          else
            echo "âœ… Projetos com testes disponÃ­veis:"
            echo "$PROJECTS_WITH_TESTS"
            
            # Executar testes apenas para projetos afetados que tÃªm target test
            echo "ğŸ§ª Executando testes em projetos afetados..."
            timeout 300 pnpm nx affected --target=test --base=${{ steps.base-ref.outputs.base_ref }} --parallel=3 || {
              echo "âš ï¸ Alguns testes falharam ou nenhum projeto afetado tem testes"
            }
          fi
          
          # Verificar projetos Go (apenas se houver mudanÃ§as em Go)
          if [ "${{ steps.changes.outputs.has_go_changes }}" = "true" ] && pnpm nx show projects --with-target=test > /dev/null 2>&1; then
            echo "ğŸ§ª Executando testes Go em projetos afetados..."
            timeout 300 pnpm nx affected --target=test --base=${{ steps.base-ref.outputs.base_ref }} --parallel=3 || {
              echo "âš ï¸ Alguns testes Go falharam ou nenhum projeto afetado tem testes Go"
            }
          elif [ "${{ steps.changes.outputs.has_go_changes }}" = "false" ]; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a em Go - pulando testes Go"
          else
            echo "â„¹ï¸ Nenhum projeto com target 'test' encontrado."
          fi
          
          echo "âœ… Testes concluÃ­dos"

      # E2E Tests removidos do desenvolvimento para velocidade
      # E2E Ã© executado apenas no ci-quality-gate.yml para main/develop

      - name: Quick Build Check
        continue-on-error: true
        if: steps.changes.outputs.has_js_changes == 'true' || steps.changes.outputs.has_go_changes == 'true'
        run: |
          echo "ğŸ—ï¸ VerificaÃ§Ã£o rÃ¡pida de build (nÃ£o bloqueante)..."
          timeout 180 pnpm nx affected --target=build --base=${{ steps.base-ref.outputs.base_ref }} --parallel=3
          echo "âœ… Build check concluÃ­do"

      - name: Development Check Summary
        if: always()
        run: |
          echo "ğŸ‰ VerificaÃ§Ã£o de desenvolvimento concluÃ­da!"
          echo "ğŸ“Š VerificaÃ§Ãµes executadas:"
          echo "  âš ï¸ Lint Check (nÃ£o bloqueante)"
          echo "  âš ï¸ Format Check (nÃ£o bloqueante)"
          echo "  âš ï¸ Type Check (nÃ£o bloqueante)"
          echo "  âœ… Tests (obrigatÃ³rio)"
          echo "  âœ… Go Tests (obrigatÃ³rio)"
          echo "  âš ï¸ Build Check (nÃ£o bloqueante)"
          echo ""
          echo "ğŸ’¡ Nota: Em desenvolvimento, apenas testes sÃ£o obrigatÃ³rios."
          echo "   Lint, format, typecheck e build sÃ£o recomendados mas nÃ£o bloqueiam."
